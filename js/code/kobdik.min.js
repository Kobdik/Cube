export default function factory(){const g=[],d={vRows:null,hRows:null},c={data:null,nh:0,nv:0,flow:null},n={PAD_ROOT:0,VER_HEIGHT:0,VER_WIDTH:0,HOR_HEIGHT:0,HOR_WIDTH:0},e=new Intl.NumberFormat("ru-RU",{maximumFractionDigits:0});new Intl.NumberFormat("ru-RU",{style:"percent"});const s=1<<30;return{getDim(o=0){return g.find(t=>t.ord===o)},getDims(){var o=new Array(g.length);for(let t=0;t<o.length;t++)o[t]=this.getDim(t);return o},getOrds(){return g},getOrd(t=0){return g[t]},getHorOrds(){return g.filter(t=>t.hor)},getVerOrds(){return g.filter(t=>!t.hor)},flipOrds(t=1,o=2){var r=g[t];g[t]=g[o],g[o]=r},flipDims(o=1,r=2){var t=g.findIndex(t=>t.ord==o),e=g.findIndex(t=>t.ord==r);this.flipOrds(t,e)},setDimHor(o=0,t=!0){var r=g.find(t=>t.ord==o);r&&(r.hor=t)},loadOrds(t){var o=this.noOper.bind(this),r=this.addVerOrd.bind(this),e=this.addHorOrd.bind(this),s=this.quoVerOrd.bind(this),l=this.quoHorOrd.bind(this),a=this.subVerOrd.bind(this),d=this.subHorOrd.bind(this);let n,i,h,c,f=-1;for(h of t)h.ord!=f&&(f=h.ord,n={ord:f,hor:!1,root:{ord:f,lev:0,exp:!0,tid:"d"+f,caption:"Измерение "+f},mode:"sum",nodes:new Map},g.push(n)),n.nodes.set(h.tid,h);f=-1,n=null;for(h of t){if(h.ord!=f&&(f=h.ord,n=this.getDim(f)),i=h.oper.dst){if(!(c=n.nodes.get(i))){console.error(`Node defs for ${i} not found!`);continue}}else c=n.root;switch(h.parent=c,h.lev=c.lev+1,h.oper.op){case"acc":h.actVerOrd=o,h.actHorOrd=o,h.act=1;break;case"add":h.actVerOrd=r,h.actHorOrd=e,h.act=1;break;case"quo":h.actVerOrd=s,h.actHorOrd=l,h.qa=n.nodes.get(h.oper.qa),h.qb=n.nodes.get(h.oper.qb),h.act=2;break;case"sub":h.actVerOrd=a,h.actHorOrd=d,h.sa=n.nodes.get(h.oper.sa),h.sb=n.nodes.get(h.oper.sb),"saldo"==h.tid&&(h.saldo_beg=n.nodes.get(h.oper.beg),h.saldo_end=n.nodes.get(h.oper.end),h.saldo_levs=[0,0,0,0,0,0,0,0]),h.act=3;break;default:h.actVerOrd=o,h.actHorOrd=o,h.act=0}c.lst_child?c.lst_child.nxt_sible=h:(c.fst_child=h,c.exp=!(1<c.lev)),c.lst_child=h}},loopDn(r,e,s){if(r.fst_child){let t=r,o=!0;do{var l=t;o&&s(l),o&&(e?l.exp:l.fst_child)?t=l.fst_child:l.nxt_sible?(t=l.nxt_sible,o=!0):(o=!1,t=l.parent)}while(t!=r)}else s(r)},loopUp(r,e){if(r.fst_child){let t=r,o=!0;do{var s=t;o&&s.fst_child?t=s.fst_child:(e(s),s.nxt_sible?(t=s.nxt_sible,o=!0):(o=!1,t=s.parent))}while(t!=r)}else e(r)},listDn(t,o,r=!1){const e=[];t=o?t.nodes.get(o):t.root;return t?this.loopDn(t,r,t=>e.push(t)):console.error(`Node defs for ${o} not found!`),e},listUp(t,o){const r=[];t=o?t.nodes.get(o):t.root;return t?this.loopUp(t,t=>r.push(t)):console.error(`Node defs for ${o} not found!`),r},getHorRows(o=0){return d.hRows.filter(t=>t.lev>o)},getVerRows(o=0){return d.vRows.filter(t=>t.lev>o)},setLays(t){Object.assign(n,t)},calcVerPad(o=!1){const{PAD_ROOT:r,VER_HEIGHT:e}=n;let s=0,l=0;for(const t of this.getVerOrds())this.loopDn(t.root,o,t=>{o||(t.row=s++),l+=0<t.lev?e:r});return l},calcHorPad(o=!1){const{PAD_ROOT:r,HOR_WIDTH:e}=n;let s=0,l=0;for(const t of this.getHorOrds())this.loopDn(t.root,o,t=>{o||(t.col=s++),l+=0<t.lev?e:r});return l},setVerRows(o=!1){const{PAD_ROOT:r,VER_HEIGHT:e}=n;let s=0,l=0,a=[];for(const t of this.getVerOrds())this.loopDn(t.root,o,t=>{o||(t.row=s++),t.pad=l,l+=0<t.lev?e:r,a.push(t)});return d.vRows=a,l},setHorRows(o=!1){const{PAD_ROOT:r,HOR_WIDTH:e}=n;let s=0,l=0,a=[];for(const t of this.getHorOrds())this.loopDn(t.root,o,t=>{o||(t.col=s++),t.pad=l,l+=0<t.lev?e:r,a.push(t)});return d.hRows=a,l},negNodes(t,o=!1){this.loopDn(t,!1,t=>{t.neg=o})},posNodes(t,o=!1){this.loopDn(t,!1,t=>{t.pos=o})},selNodes(t,o=!1){const r=[];return this.loopDn(t,!1,t=>{t.sel=o,r.push(t)}),r},getSelected(t){const o=[];return this.loopDn(t,!1,t=>{t.sel&&o.push(t)}),o},getMatrix(){return c},createMatrix(){var t=this.getHorOrds(),o=this.getVerOrds();let r=0,e=0;for(const d of o)r+=d.nodes.size+1;for(const n of t)e+=n.nodes.size+1;var s=e,l=r;c.data=new Int32Array(s*l*4),c.nh=s,c.nv=l,c.grids=[];for(const i of o)for(const h of t){var a={hOrd:h,vOrd:i,fOrds:g.filter(t=>t.ord!=h.ord&&t.ord!=i.ord).map(t=>t.ord)};c.grids.push(a)}return console.log("matrix created",r,e),c},addVal(t,o,r,e){c.data[4*t*c.nh+4*o+r]+=e},setVal(t,o,r,e){c.data[4*t*c.nh+4*o+r]=e},getVal(t,o,r=1){return c.data[4*t*c.nh+4*o+r]},getFixVal(t,o,r=1){t=c.data[4*t*c.nh+4*o+r];return t<s?e.format(t):"###"},getAvgVal(t,o){var r=c.data[4*t*c.nh+4*o],t=c.data[4*t*c.nh+4*o+1];return 0<r?e.format(t/r):"###"},getMinMax(t,o){return""+c.data[4*t*c.nh+4*o+3]},initFlow(t,o=!1){let r=1;var e=this.getDims();for(const l of t){l.nodes=new Array(e.length);for(const a of e){var s=a.nodes.get(l.keys[a.ord]);s||console.log(r++,"key:",l.keys[a.ord],"not found for",l),l.nodes[a.ord]=s||a.root}if(20<r){console.error("too many errors loading data");break}}c.flow=o?c.flow.concat(t):t},getGrids(){return c.grids},getFiltGrids(o){return c.grids.filter(t=>t.fOrds.includes(o))},zeroGrid(t){this.loopUp(t.vOrd.root,o=>{this.loopUp(t.hOrd.root,t=>{this.setVal(o.row,t.col,0,0),this.setVal(o.row,t.col,1,0),this.setVal(o.row,t.col,2,s),this.setVal(o.row,t.col,3,-s)})})},flowGrid(r){var e,s,l,a=r.vOrd.root.ord,d=r.hOrd.root.ord;for(const i of c.flow){let t=!0,o=!1;for(const h of r.fOrds){var n=i.nodes[h];if(!n.sel){t=!1;break}n.neg&&(o=!o)}t&&(e=i.nodes[a].row,s=i.nodes[d].col,l=o?-i.val:i.val,this.addVal(e,s,0,1),this.addVal(e,s,1,l),this.getVal(e,s,2)>l&&this.setVal(e,s,2,l),this.getVal(e,s,3)<l)&&this.setVal(e,s,3,l)}},noOper(){},addVerOrd(t,o){var o=o.col,r=(this.addVal(t.parent.row,o,0,this.getVal(t.row,o,0)),this.addVal(t.parent.row,o,1,this.getVal(t.row,o,1)),this.getVal(t.row,o,2)),r=(this.getVal(t.parent.row,o,2)>r&&this.setVal(t.parent.row,o,2,r),this.getVal(t.row,o,3));this.getVal(t.parent.row,o,3)<r&&this.setVal(t.parent.row,o,3,r)},quoVerOrd(t,o){var o=o.col,r=this.getVal(t.qb.row,o,1),r=0!=r?100*this.getVal(t.qa.row,o,1)/r:s;this.setVal(t.row,o,1,r)},subVerOrd(t,o){var r,e=o.col;this.setVal(t.row,e,1,this.getVal(t.sa.row,e,1)-this.getVal(t.sb.row,e,1)),t.saldo_levs&&1==o.ord&&(this.setVal(t.saldo_beg.row,e,1,t.saldo_levs[o.lev]),r=t.saldo_levs[o.lev]+this.getVal(t.row,e,1),this.setVal(t.saldo_end.row,e,1,r),t.saldo_levs[o.lev]=r)},addHorOrd(t,o){this.addVal(t,o.parent.col,0,this.getVal(t,o.col,0)),this.addVal(t,o.parent.col,1,this.getVal(t,o.col,1));var r=this.getVal(t,o.col,2),r=(this.getVal(t,o.parent.col,2)>r&&this.setVal(t,o.parent.col,2,r),this.getVal(t,o.col,3));this.getVal(t,o.parent.col,3)<r&&this.setVal(t,o.parent.col,3,r)},quoHorOrd(t,o){var r=this.getVal(t,o.qb.col,1),r=0!=r?100*this.getVal(t,o.qa.col,1)/r:s;this.setVal(t,o.col,1,r)},subHorOrd(t,o){this.setVal(t,o.col,1,this.getVal(t,o.sa.col,1)-this.getVal(t,o.sb.col,1))},fillGrid(t){var o=this.listUp(t.vOrd,t.root),r=this.listUp(t.hOrd,t.root);for(const e of o){if(e.saldo_levs){const s=this.getVal(e.row,1,1);e.saldo_levs.forEach((t,o)=>{e.saldo_levs[o]=s})}if(0<e.act)for(const l of r)e.actVerOrd(e,l);if(1===e.act)for(const a of r)a.actHorOrd(e.row,a)}}}}