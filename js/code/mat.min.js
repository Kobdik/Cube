import{actionCreators,TYPES}from"./sutils.min.js";import kobdikFactory from"./kobdik.min.js";const{askBinaryOrdsAsync,askBinaryDataAsync,askConfOrdsAsync,askConfDataAsync,askJsonOrdsAsync,askJsonDataAsync}=actionCreators,PAD_ROOT=25,VER_HEIGHT=25,VER_WIDTH=325,HOR_HEIGHT=200,HOR_WIDTH=100;window.addEventListener("load",function(){const d=kobdikFactory(),o={height:1e3,width:1e3,posX:0,posY:0,overX:0,overY:0,touchMove:!1,touchStartX:0,touchStartY:0,touchMoveX:0,touchMoveY:0},n=(window.cobdy=d,d3.select("svg.multi")),l=n.select("g.hor-ords"),i=n.select("g.ver-ords"),c=n.select("g.matrix"),H=n.select("#hor-clip rect"),h=n.select("#ver-clip rect"),p=n.select("#mat-clip rect");function e(t){switch(t.type){case TYPES.ON_ERROR:console.error(t);break;case TYPES.INIT_ORDS:setTimeout(a,0,t.ords);break;case TYPES.INIT_DATA:setTimeout(g,0,t.rows,t.add);break;default:console.log("action.type",t.type)}}function s(){var t=document.body.clientWidth,t=t<=720?.5:t<=1080?.75:1,e=d.calcHorPad(!1),s=d.calcVerPad(!1),e=e+VER_WIDTH,s=s+HOR_HEIGHT,a=Math.round(e*t),r=Math.round(s*t);H.attr("width",Math.round(e/t)).attr("height",HOR_HEIGHT),h.attr("width",Math.round(VER_WIDTH)).attr("height",s),p.attr("width",Math.round(e/t)).attr("height",s),n.attr("viewBox",`0, 0, ${e}, `+s),n.attr("width",a).attr("height",r),o.height=s,o.width=e}function a(t){d.loadOrds(t),d.setLays({PAD_ROOT:PAD_ROOT,VER_HEIGHT:VER_HEIGHT,VER_WIDTH:VER_WIDTH,HOR_HEIGHT:HOR_HEIGHT,HOR_WIDTH:HOR_WIDTH}),d.setDimHor(0,!0),d.flipDims(0,1),d.setDimHor(1,!0),d.flipDims(2,3),setTimeout(askJsonDataAsync("mat-rows.json",!1),0,e),setTimeout(askJsonDataAsync("mat-adds.json",!0),2e3,e),t=!0,d.createMatrix(),s(),f(t),m(t)}function r(t,e){1===e.act?setTimeout(T,0,e):3===e.act&&setTimeout(u,0,e,t.target.closest("g"))}function u(t,e){var s=d.getDim(t.ord);if(s)if(s.subn&&s.subn!=t)console.log("active neg differ");else{var a="sum"===s.mode,r=(s.mode=a?"sub":"sum",s.subn=a?t:null,d.selNodes(t.sa,a)),o=d.selNodes(t.sb,a),n=(d.posNodes(t.sa,a),d.negNodes(t.sb,a),d.getGrids());for(const c of n)d.zeroGrid(c),d.flowGrid(c),d.fillGrid(c);d3.select(e).classed("sub",a);n=s.hor?l.selectAll(`g.hor-node[ord="${t.ord}"]`):i.selectAll(`g.ver-node[ord="${t.ord}"]`);n.data(r,t=>t.tid).classed("sel",t=>t.sel).classed("pos",t=>t.pos),n.data(o,t=>t.tid).classed("sel",t=>t.sel).classed("neg",t=>t.neg),setTimeout(D,90,!0)}}function T(t){var e=d.getDim(t.ord);if(e){var s=d.selNodes(t,!t.sel);for(const r of d.getFiltGrids(e.ord)){var a=performance.now();d.zeroGrid(r),d.flowGrid(r),d.fillGrid(r),performance.measure(`grid_${r.hOrd.ord}-`+r.vOrd.ord,{start:a,end:performance.now()})}for(const o of performance.getEntries())"measure"==o.entryType&&console.log(`${o.name}. Duration ${o.duration}ms`);performance.clearMeasures(),(e.hor?l.selectAll(`g.hor-node[ord="${t.ord}"]`):i.selectAll(`g.ver-node[ord="${t.ord}"]`)).data(s,t=>t.tid).classed("sel",t=>t.sel),setTimeout(D,0,!0)}}function v(t,e){var s;e.fst_child?(e.exp=!e.exp,(s=d.getDim(e.ord))&&((s.hor?m:f)(!0),setTimeout(D,0,!0))):console.log("txt",e)}function R(t,e){e?t.classed("hide",!0):t.remove()}function _(t){t.classed("hide",!1).classed("sel",t=>t.sel).classed("exp",t=>null!=t.fst_child).classed("cls",t=>!!t.fst_child&&!t.exp).attr("transform",t=>`translate(0, ${t.pad})`).select("path.curve").attr("d",t=>`M${15*t.lev-5},12L${15*(t.lev-1)-5},12,${15*(t.lev-1)-5},`+(t.parent.pad-t.pad+12))}function f(e=!1){d.setVerRows(e);var t=d.getVerRows(0);i.selectAll("g.ver-node").data(t,t=>t.tid).join(t=>{(t=(t=t).append("svg:g").attr("id",t=>t.tid).attr("ord",t=>t.ord).classed("ver-node",!0)).append("svg:rect").classed("cmd-ver",!0).attr("x",0).attr("y",0).on("click",r).append("svg:title").text(t=>t.title),t.append("svg:text").attr("transform",t=>`translate(${15*t.lev}, ${VER_HEIGHT/2+5})`).text(t=>t.caption).on("click",v),t.filter(t=>1<t.lev).append("svg:path").classed("curve",!0),t.call(_)},t=>_(t),t=>R(t,e))}function E(t){t.classed("hide",!1).classed("sel",t=>t.sel).classed("exp",t=>null!=t.fst_child).classed("cls",t=>!!t.fst_child&&!t.exp).attr("transform",t=>`translate(${t.pad}, 0)`).select("path.curve").attr("d",t=>`M${HOR_WIDTH/2-10},${HOR_HEIGHT-15*t.lev+5}L${HOR_WIDTH/2-10},${HOR_HEIGHT-15*(t.lev-1)+5}
                ${t.parent.pad-t.pad+HOR_WIDTH/2-10},`+(HOR_HEIGHT-15*(t.lev-1)+5))}function m(e=!1){d.setHorRows(e);var t=d.getHorRows(0);l.selectAll("g.hor-node").data(t,t=>t.tid).join(t=>{(t=(t=t).append("svg:g").attr("id",t=>t.tid).attr("ord",t=>t.ord).classed("hor-node",!0)).append("svg:rect").classed("cmd-hor",!0).attr("x",0).attr("y",0).on("click",r).append("svg:title").text(t=>t.title),t.append("svg:text").attr("transform",t=>`translate(${HOR_WIDTH/2-12}, ${HOR_HEIGHT-15*t.lev}) rotate (-60)`).text(t=>t.caption).on("click",v),t.filter(t=>1<t.lev).append("svg:path").classed("curve",!0),t.call(E)},t=>E(t),t=>R(t,e))}function g(t,e=!1){d.initFlow(t,e),e||(e=new MouseEvent("click"),i.select("#cem").select("rect").node().dispatchEvent(e),i.select("#vnd1").select("rect").node().dispatchEvent(e),i.select("#vnd2").select("rect").node().dispatchEvent(e),i.select("#st1").select("rect").node().dispatchEvent(e),i.select("#st2").select("rect").node().dispatchEvent(e),l.select("#c2025-09").select("rect").node().dispatchEvent(e),l.select("#c2025-09").select("text").node().dispatchEvent(e),l.select("#p2025").select("rect").node().dispatchEvent(e)),setTimeout(D,90,!0),console.log("rows loaded:",t.length)}function O(t){t.classed("hide",!1).classed("sel",t=>t.sel).attr("transform",t=>`translate(${t.pad}, 0)`).select("text").text(t=>d.getFixVal(t.row,t.col,1))}function I(t,e,s){t.classed("hide",!1).classed("sel",t=>t.sel).attr("transform",t=>`translate(0, ${t.pad})`).selectAll("g.cell").data(e=>s.map(t=>({...t,row:e.row})),t=>t.tid).join(t=>{(t=(t=t).append("svg:g").classed("cell",!0).attr("key",t=>t.tid).attr("row",t=>t.row).attr("col",t=>t.col).attr("ord",t=>t.ord)).append("svg:rect").attr("x",0).attr("y",0),t.append("svg:text").attr("transform",`translate(${HOR_WIDTH-5}, ${VER_HEIGHT/2+5})`),t.call(O)},t=>O(t),t=>R(t,e))}function D(a=!1){var t=d.getVerRows(0);const r=d.getHorRows(0);c.selectAll("g.tape").data(t,t=>t.tid).join(t=>{var e,s;t=t,e=a,s=r,t.append("svg:g").classed("tape",!0).attr("key",t=>t.tid).attr("row",t=>t.row).attr("ord",t=>t.ord).call(I,e,s)},t=>I(t,a,r),t=>R(t,a))}l.attr("transform",`translate(${VER_WIDTH}, 0)`),i.attr("transform",`translate(0, ${HOR_HEIGHT})`),c.attr("transform",`translate(${VER_WIDTH}, ${HOR_HEIGHT})`),window.addEventListener("resize",s),n.on("touchstart",function(t){o.touchStartX=t.touches[0].clientX,o.touchStartY=t.touches[0].clientY}),n.on("touchmove",function(t){o.touchMoveX=t.touches[0].clientX,o.touchMoveY=t.touches[0].clientY,o.touchMove=!0}),n.on("touchend",function(t){var e=o.touchStartX-o.touchMoveX,s=o.touchStartY-o.touchMoveY;o.touchMove&&(t.preventDefault(),t=e,e=s,e=(e=o.posY+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<o.height-5*VER_HEIGHT-HOR_HEIGHT?e:o.height-5*VER_HEIGHT-HOR_HEIGHT,o.posY=e,t=(t=o.posX+PAD_ROOT*Math.round(t/PAD_ROOT))<0?0:t<o.width-5*HOR_WIDTH-VER_WIDTH?t:o.width-5*HOR_WIDTH-VER_WIDTH,o.posX=t,h.attr("y",e),i.attr("transform",`translate(0, ${HOR_HEIGHT-e})`),H.attr("x",t),l.attr("transform",`translate(${VER_WIDTH-t}, 0)`),p.attr("x",t),p.attr("y",e),c.attr("transform",`translate(${VER_WIDTH-t}, ${HOR_HEIGHT-e})`),o.touchMove=!1)}),n.on("wheel",function(t){var e;t.preventDefault(),t.shiftKey||0!=t.deltaX?(e=0!=t.deltaX?t.deltaX:t.deltaY,e=(e=o.posX+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<o.width-5*HOR_WIDTH-VER_WIDTH?e:o.width-5*HOR_WIDTH-VER_WIDTH,o.posX=e,H.attr("x",e),l.attr("transform",`translate(${VER_WIDTH-e}, 0)`),p.attr("x",e),c.attr("transform",`translate(${VER_WIDTH-e}, ${HOR_HEIGHT-o.posY})`)):(e=t.deltaY,e=(e=o.posY+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<o.height-5*VER_HEIGHT-HOR_HEIGHT?e:o.height-5*VER_HEIGHT-HOR_HEIGHT,o.posY=e,h.attr("y",e),i.attr("transform",`translate(0, ${HOR_HEIGHT-e})`),p.attr("y",e),c.attr("transform",`translate(${VER_WIDTH-o.posX}, ${HOR_HEIGHT-e})`))}),askJsonOrdsAsync("mat-ords.json")(e)});