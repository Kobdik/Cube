export default function factory(){const f=[],i={vRows:null,hRows:null},u={data:null,nh:0,nv:0,flow:null},n={PAD_ROOT:0,VER_HEIGHT:0,VER_WIDTH:0,HOR_HEIGHT:0,HOR_WIDTH:0},r=new Intl.NumberFormat("ru-RU",{maximumFractionDigits:0});new Intl.NumberFormat("ru-RU",{style:"percent"});const e=1<<30;return{getDim(o=0){return f.find(t=>t.ord===o)},getDims(){var o=[];o.length=f.length;for(let t=0;t<o.length;t++)o[t]=this.getDim(t);return o},getOrds(){return f},getOrd(t=0){return f[t]},getHorOrds(){return f.filter(t=>t.hor)},getVerOrds(){return f.filter(t=>!t.hor)},flipOrds(t=1,o=2){var r=f[t];f[t]=f[o],f[o]=r},flipDims(o=1,r=2){var t=f.findIndex(t=>t.ord==o),e=f.findIndex(t=>t.ord==r);this.flipOrds(t,e)},setDimHor(o=0,t=!0){var r=f.find(t=>t.ord==o);r&&(r.hor=t)},loadOrds(t){var o=this.noOper.bind(this),r=this.addVerSum.bind(this),e=this.addHorSum.bind(this),s=this.quoVerSum.bind(this),l=this.quoHorSum.bind(this),d=this.subVerSum.bind(this),i=this.subHorSum.bind(this);let n,a,h,u,c=-1;for(h of t)h.ord!=c&&(c=h.ord,n={ord:c,hor:!1,root:{ord:c,lev:0,exp:!0,tid:"d"+c,caption:"Измерение "+c},mode:"sum",nodes:new Map},f.push(n)),n.nodes.set(h.tid,h);c=-1,n=null;for(h of t){if(h.ord!=c&&(c=h.ord,n=this.getDim(c)),a=h.oper.dst){if(!(u=n.nodes.get(a))){console.error(`Node defs for ${a} not found!`);continue}}else u=n.root;switch(h.parent=u,h.oper.op){case"acc":h.actVerSum=o,h.actHorSum=o,h.act=1;break;case"add":h.actVerSum=r,h.actHorSum=e,h.act=1;break;case"quo":h.actVerSum=s,h.actHorSum=l,h.qa=n.nodes.get(h.oper.qa),h.qb=n.nodes.get(h.oper.qb),h.act=2;break;case"sub":h.actVerSum=d,h.actHorSum=i,h.sa=n.nodes.get(h.oper.sa),h.sb=n.nodes.get(h.oper.sb),h.act=3;break;default:h.actVerSum=o,h.actHorSum=o,h.act=0}h.lev=u.lev+1,u.lst_child?u.lst_child.nxt_sible=h:(u.fst_child=h,u.exp=!0),u.lst_child=h}},loopDn(r,e,s){if(r.fst_child){let t=r,o=!0;do{var l=t;o&&s(l),o&&(e?l.exp:l.fst_child)?t=l.fst_child:l.nxt_sible?(t=l.nxt_sible,o=!0):(o=!1,t=l.parent)}while(t!=r)}else s(r)},loopUp(r,e){if(r.fst_child){let t=r,o=!0;do{var s=t;o&&s.fst_child?t=s.fst_child:(e(s),s.nxt_sible?(t=s.nxt_sible,o=!0):(o=!1,t=s.parent))}while(t!=r)}else e(r)},listDn(t,o,r=!1){const e=[];t=o?t.nodes.get(o):t.root;return t?this.loopDn(t,r,t=>e.push(t)):console.error(`Node defs for ${o} not found!`),e},listUp(t,o){const r=[];t=o?t.nodes.get(o):t.root;return t?this.loopUp(t,t=>r.push(t)):console.error(`Node defs for ${o} not found!`),r},getHorRows(){return i.hRows},getVerRows(){return i.vRows},setLays(t){Object.assign(n,t)},setVerRows(o=!1){const{PAD_ROOT:r,VER_HEIGHT:e}=n;let s=0,l=0,d=[];for(const t of this.getVerOrds())this.loopDn(t.root,o,t=>{o||(t.row=s),t.pad=l,l+=0<t.lev?e:r,t.ind=s++,d.push(t)});return i.vRows=d,l},setHorRows(o=!1){const{PAD_ROOT:r,HOR_WIDTH:e}=n;let s=0,l=0,d=[];for(const t of this.getHorOrds())this.loopDn(t.root,o,t=>{o||(t.col=s),t.pad=l,l+=0<t.lev?e:r,t.ind=s++,d.push(t)});return i.hRows=d,l},negNodes(t,o=!1){this.loopDn(t,!1,t=>{t.neg=o})},posNodes(t,o=!1){this.loopDn(t,!1,t=>{t.pos=o})},selNodes(t,o=!1){const r=[];return this.loopDn(t,!1,t=>{t.sel=o,r.push(t)}),r},getSelected(t){const o=[];return this.loopDn(t,!1,t=>{t.sel&&o.push(t)}),o},getMatrix(){return u},createMatrix(){var t=i.hRows.length,o=i.vRows.length,r=(u.data=new Float32Array(t*o),u.nh=t,u.nv=o,u.grids=[],this.getHorOrds());for(const s of this.getVerOrds())for(const l of r){var e={hOrd:l,vOrd:s,fOrds:f.filter(t=>t.ord!=l.ord&&t.ord!=s.ord).map(t=>t.ord)};u.grids.push(e)}return u.getCols=(o=0)=>this.getHorRows().filter(t=>t.lev>o),u.getRows=(o=0)=>this.getVerRows().filter(t=>t.lev>o),u},addVal(t,o,r){u.data[t*u.nh+o]+=r},setVal(t,o,r){u.data[t*u.nh+o]=r},getVal(t,o){return u.data[t*u.nh+o]},getFixVal(t,o){t=u.data[t*u.nh+o];return t<e?r.format(t):"###"},getGrids(){return u.grids},getFiltGrids(o){return u.grids.filter(t=>t.fOrds.includes(o))},setFlow(t){u.flow=t},zeroGrid(t){this.loopUp(t.vOrd.root,o=>{this.loopUp(t.hOrd.root,t=>{this.setVal(o.row,t.col,0)})})},flowGrid(r){var e,s,l,d=r.vOrd.root.ord,i=r.hOrd.root.ord;for(const a of u.flow){let t=!0,o=!1;for(const h of r.fOrds){var n=a.nodes[h];if(!n.sel){t=!1;break}n.neg&&(o=!o)}t&&(e=a.nodes[d].row,s=a.nodes[i].col,l=o?-a.val:a.val,this.addVal(e,s,l))}},noOper(){},addVerSum(t,o){this.addVal(t.parent.row,o,this.getVal(t.row,o))},quoVerSum(t,o){var r=this.getVal(t.qb.row,o),r=0!=r?100*this.getVal(t.qa.row,o)/r:e;this.setVal(t.row,o,r)},subVerSum(t,o){this.setVal(t.row,o,this.getVal(t.sa.row,o)-this.getVal(t.sb.row,o))},addHorSum(t,o){this.addVal(t,o.parent.col,this.getVal(t,o.col))},quoHorSum(t,o){var r=this.getVal(t,o.qb.col),r=0!=r?100*this.getVal(t,o.qa.col)/r:e;this.setVal(t,o.col,r)},subHorSum(t,o){this.setVal(t,o.col,this.getVal(t,o.sa.col)-this.getVal(t,o.sb.col))},fillGrid(t){var o=t.vOrd.root;const r=t.hOrd.root;this.loopUp(o,o=>{this.loopUp(r,t=>{o.actVerSum(o,t.col)}),1===o.act&&this.loopUp(r,t=>{t.actHorSum(o.row,t)})})}}}