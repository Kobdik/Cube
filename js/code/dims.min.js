export default function factory(){const f=[],i={vRows:null,hRows:null},c={data:null,nh:0,nv:0,flow:null},n={PAD_ROOT:0,VER_HEIGHT:0,VER_WIDTH:0,HOR_HEIGHT:0,HOR_WIDTH:0},e=new Intl.NumberFormat("ru-RU",{maximumFractionDigits:0});new Intl.NumberFormat("ru-RU",{style:"percent"});const s=1<<30;return{getDim(r=0){return f.find(t=>t.ord===r)},getDims(){var r=[];r.length=f.length;for(let t=0;t<r.length;t++)r[t]=this.getDim(t);return r},getOrds(){return f},getOrd(t=0){return f[t]},getHorOrds(){return f.filter(t=>t.hor)},getVerOrds(){return f.filter(t=>!t.hor)},flipOrds(t=1,r=2){var o=f[t];f[t]=f[r],f[r]=o},flipDims(r=1,o=2){var t=f.findIndex(t=>t.ord==r),e=f.findIndex(t=>t.ord==o);this.flipOrds(t,e)},setDimHor(r=0,t=!0){var o=f.find(t=>t.ord==r);o&&(o.hor=t)},loadOrds(t){var r=this.noOper.bind(this),o=this.addVerSum.bind(this),e=this.addHorSum.bind(this),s=this.quoVerSum.bind(this),l=this.quoHorSum.bind(this),a=this.subVerSum.bind(this),i=this.subHorSum.bind(this);let n,d,h,c,u=-1;for(h of t)h.ord!=u&&(u=h.ord,n={ord:u,hor:!1,root:{ord:u,lev:0,exp:!0,tid:"d"+u,caption:"Измерение "+u},mode:"sum",nodes:new Map},f.push(n)),n.nodes.set(h.tid,h);u=-1,n=null;for(h of t){if(h.ord!=u&&(u=h.ord,n=this.getDim(u)),d=h.oper.dst){if(!(c=n.nodes.get(d))){console.error(`Node defs for ${d} not found!`);continue}}else c=n.root;switch(h.parent=c,h.oper.op){case"acc":h.actVerSum=r,h.actHorSum=r,h.act=1;break;case"add":h.actVerSum=o,h.actHorSum=e,h.act=1;break;case"quo":h.actVerSum=s,h.actHorSum=l,h.qa=n.nodes.get(h.oper.qa),h.qb=n.nodes.get(h.oper.qb),h.act=2;break;case"sub":h.actVerSum=a,h.actHorSum=i,h.sa=n.nodes.get(h.oper.sa),h.sb=n.nodes.get(h.oper.sb),h.act=3;break;default:h.actVerSum=r,h.actHorSum=r,h.act=0}h.lev=c.lev+1,c.lst_child?c.lst_child.nxt_sible=h:(c.fst_child=h,c.exp=!(1<c.lev)),c.lst_child=h}},loopDn(o,e,s){if(o.fst_child){let t=o,r=!0;do{var l=t;r&&s(l),r&&(e?l.exp:l.fst_child)?t=l.fst_child:l.nxt_sible?(t=l.nxt_sible,r=!0):(r=!1,t=l.parent)}while(t!=o)}else s(o)},loopUp(o,e){if(o.fst_child){let t=o,r=!0;do{var s=t;r&&s.fst_child?t=s.fst_child:(e(s),s.nxt_sible?(t=s.nxt_sible,r=!0):(r=!1,t=s.parent))}while(t!=o)}else e(o)},listDn(t,r,o=!1){const e=[];t=r?t.nodes.get(r):t.root;return t?this.loopDn(t,o,t=>e.push(t)):console.error(`Node defs for ${r} not found!`),e},listUp(t,r){const o=[];t=r?t.nodes.get(r):t.root;return t?this.loopUp(t,t=>o.push(t)):console.error(`Node defs for ${r} not found!`),o},getHorRows(){return i.hRows},getVerRows(){return i.vRows},setLays(t){Object.assign(n,t)},setVerRows(r=!1){const{PAD_ROOT:o,VER_HEIGHT:e}=n;let s=0,l=0,a=[];for(const t of this.getVerOrds())this.loopDn(t.root,r,t=>{r||(t.row=s),t.pad=l,l+=0<t.lev?e:o,t.ind=s++,a.push(t)});return i.vRows=a,l},setHorRows(r=!1){const{PAD_ROOT:o,HOR_WIDTH:e}=n;let s=0,l=0,a=[];for(const t of this.getHorOrds())this.loopDn(t.root,r,t=>{r||(t.col=s),t.pad=l,l+=0<t.lev?e:o,t.ind=s++,a.push(t)});return i.hRows=a,l},negNodes(t,r=!1){this.loopDn(t,!1,t=>{t.neg=r})},posNodes(t,r=!1){this.loopDn(t,!1,t=>{t.pos=r})},selNodes(t,r=!1){const o=[];return this.loopDn(t,!1,t=>{t.sel=r,o.push(t)}),o},getSelected(t){const r=[];return this.loopDn(t,!1,t=>{t.sel&&r.push(t)}),r},getMatrix(){return c},createMatrix(){var t=i.hRows.length,r=i.vRows.length,o=(c.data=new Int32Array(t*r*4),c.nh=t,c.nv=r,c.grids=[],this.getHorOrds());for(const s of this.getVerOrds())for(const l of o){var e={hOrd:l,vOrd:s,fOrds:f.filter(t=>t.ord!=l.ord&&t.ord!=s.ord).map(t=>t.ord)};c.grids.push(e)}return c.getCols=(r=0)=>this.getHorRows().filter(t=>t.lev>r),c.getRows=(r=0)=>this.getVerRows().filter(t=>t.lev>r),c},addVal(t,r,o,e){c.data[4*t*c.nh+4*r+o]+=e},setVal(t,r,o,e){c.data[4*t*c.nh+4*r+o]=e},getVal(t,r,o=1){return c.data[4*t*c.nh+4*r+o]},getFixVal(t,r,o=1){t=c.data[4*t*c.nh+4*r+o];return t<s?e.format(t):"###"},getAvgVal(t,r){var o=c.data[4*t*c.nh+4*r],t=c.data[4*t*c.nh+4*r+1];return 0<o?e.format(t/o):"###"},getMinMax(t,r){return""+c.data[4*t*c.nh+4*r+3]},getGrids(){return c.grids},getFiltGrids(r){return c.grids.filter(t=>t.fOrds.includes(r))},setFlow(t){c.flow=t},zeroGrid(t){this.loopUp(t.vOrd.root,r=>{this.loopUp(t.hOrd.root,t=>{this.setVal(r.row,t.col,0,0),this.setVal(r.row,t.col,1,0),this.setVal(r.row,t.col,2,s),this.setVal(r.row,t.col,3,-s)})})},flowGrid(o){var e,s,l,a=o.vOrd.root.ord,i=o.hOrd.root.ord;for(const d of c.flow){let t=!0,r=!1;for(const h of o.fOrds){var n=d.nodes[h];if(!n.sel){t=!1;break}n.neg&&(r=!r)}t&&(e=d.nodes[a].row,s=d.nodes[i].col,l=r?-d.val:d.val,this.addVal(e,s,0,1),this.addVal(e,s,1,l),this.getVal(e,s,2)>l&&this.setVal(e,s,2,l),this.getVal(e,s,3)<l)&&this.setVal(e,s,3,l)}},noOper(){},addVerSum(t,r){this.addVal(t.parent.row,r,0,this.getVal(t.row,r,0)),this.addVal(t.parent.row,r,1,this.getVal(t.row,r,1));var o=this.getVal(t.row,r,2),o=(this.getVal(t.parent.row,r,2)>o&&this.setVal(t.parent.row,r,2,o),this.getVal(t.row,r,3));this.getVal(t.parent.row,r,3)<o&&this.setVal(t.parent.row,r,3,o)},quoVerSum(t,r){var o=this.getVal(t.qb.row,r,1),o=0!=o?100*this.getVal(t.qa.row,r,1)/o:s;this.setVal(t.row,r,1,o)},subVerSum(t,r){this.setVal(t.row,r,1,this.getVal(t.sa.row,r,1)-this.getVal(t.sb.row,r,1))},addHorSum(t,r){this.addVal(t,r.parent.col,0,this.getVal(t,r.col,0)),this.addVal(t,r.parent.col,1,this.getVal(t,r.col,1));var o=this.getVal(t,r.col,2),o=(this.getVal(t,r.parent.col,2)>o&&this.setVal(t,r.parent.col,2,o),this.getVal(t,r.col,3));this.getVal(t,r.parent.col,3)<o&&this.setVal(t,r.parent.col,3,o)},quoHorSum(t,r){var o=this.getVal(t,r.qb.col,1),o=0!=o?100*this.getVal(t,r.qa.col,1)/o:s;this.setVal(t,r.col,1,o)},subHorSum(t,r){this.setVal(t,r.col,1,this.getVal(t,r.sa.col,1)-this.getVal(t,r.sb.col,1))},fillGrid(t){var r=this.listUp(t.vOrd,t.root),o=this.listUp(t.hOrd,t.root);for(const e of r){for(const s of o)e.actVerSum(e,s.col);if(1===e.act)for(const l of o)l.actHorSum(e.row,l)}}}}