import{actionCreators,TYPES}from"./sutils.min.js";import kobdikFactory from"./kobdik.min.js";const{askBinaryOrdsAsync,askBinaryDataAsync,askConfOrdsAsync,askConfDataAsync,askJsonOrdsAsync,askJsonDataAsync}=actionCreators,PAD_ROOT=25,VER_HEIGHT=25,VER_WIDTH=325,HOR_HEIGHT=200,HOR_WIDTH=120;window.addEventListener("load",function(){const c=kobdikFactory(),r={height:1e3,width:1e3,posX:0,posY:0,overX:0,overY:0,touchMove:!1,touchStartX:0,touchStartY:0,touchMoveX:0,touchMoveY:0},n=(window.cobdy=c,d3.select("svg.multi")),d=n.select("g.hor-ords"),i=n.select("g.ver-ords"),l=n.select("g.matrix"),H=n.select("#hor-clip rect"),h=n.select("#ver-clip rect"),p=n.select("#mat-clip rect");function e(t){switch(t.type){case TYPES.ON_ERROR:console.error(t);break;case TYPES.INIT_ORDS:setTimeout(a,0,t.ords);break;case TYPES.INIT_DATA:setTimeout(O,0,t.rows,t.add);break;default:console.log("action.type",t.type)}}function s(){var t=document.body.clientWidth,t=t<=720?.5:t<=1080?.75:1,e=c.calcHorPad(!1),s=c.calcVerPad(!1),e=e+VER_WIDTH,s=s+HOR_HEIGHT,a=Math.round(e*t),o=Math.round(s*t);H.attr("width",Math.round(e/t)).attr("height",HOR_HEIGHT),h.attr("width",Math.round(VER_WIDTH)).attr("height",s),p.attr("width",Math.round(e/t)).attr("height",s),n.attr("viewBox",`0, 0, ${e}, `+s),n.attr("width",a).attr("height",o),r.height=s,r.width=e}function a(t){c.loadOrds(t),c.setLays({PAD_ROOT:PAD_ROOT,VER_HEIGHT:VER_HEIGHT,VER_WIDTH:VER_WIDTH,HOR_HEIGHT:HOR_HEIGHT,HOR_WIDTH:HOR_WIDTH}),c.setDimHor(1,!0),c.flipDims(0,1),setTimeout(askJsonDataAsync("rows.json"),0,e),t=!0,c.createMatrix(),s(),v(t),g(t)}function o(t,e){1===e.act?setTimeout(T,0,e):3===e.act&&setTimeout(u,0,e,t.target.closest("g"))}function u(t,e){var s=c.getDim(t.ord);if(s)if(s.subn&&s.subn!=t)console.log("active neg differ");else{var a="sum"===s.mode,o=(s.mode=a?"sub":"sum",s.subn=a?t:null,c.selNodes(t.sa,a)),r=c.selNodes(t.sb,a),n=(c.posNodes(t.sa,a),c.negNodes(t.sb,a),c.getGrids());for(const l of n)c.zeroGrid(l),c.flowGrid(l),c.fillGrid(l);d3.select(e).classed("sub",a);n=s.hor?d.selectAll(`g.hor-node[ord="${t.ord}"]`):i.selectAll(`g.ver-node[ord="${t.ord}"]`);n.data(o,t=>t.tid).classed("sel",t=>t.sel).classed("pos",t=>t.pos),n.data(r,t=>t.tid).classed("sel",t=>t.sel).classed("neg",t=>t.neg),setTimeout(D,0,!0)}}function T(t){var e=c.getDim(t.ord);if(e){var s=c.selNodes(t,!t.sel);for(const o of c.getFiltGrids(e.ord)){var a=performance.now();c.zeroGrid(o),c.flowGrid(o),c.fillGrid(o),performance.measure(`grid_${o.hOrd.ord}-`+o.vOrd.ord,{start:a,end:performance.now()})}for(const r of performance.getEntries())"measure"==r.entryType&&console.log(`${r.name}. Duration ${r.duration}ms`);performance.clearMeasures(),(e.hor?d.selectAll(`g.hor-node[ord="${t.ord}"]`):i.selectAll(`g.ver-node[ord="${t.ord}"]`)).data(s,t=>t.tid).classed("sel",t=>t.sel),setTimeout(D,0,!0)}}function R(t,e){var s;e.fst_child?(e.exp=!e.exp,(s=c.getDim(e.ord))&&((s.hor?g:v)(!0),setTimeout(D,0,!0))):console.log("txt",e)}function _(t,e){e?t.classed("hide",!0):t.remove()}function f(t){t.classed("hide",!1).classed("sel",t=>t.sel).classed("exp",t=>null!=t.fst_child).classed("cls",t=>!!t.fst_child&&!t.exp).attr("transform",t=>`translate(0, ${t.pad})`).select("path.curve").attr("d",t=>`M${15*t.lev-5},12L${15*(t.lev-1)-5},12,${15*(t.lev-1)-5},`+(t.parent.pad-t.pad+12))}function v(e=!1){c.setVerRows(e);var t=c.getVerRows(0);i.selectAll("g.ver-node").data(t,t=>t.tid).join(t=>{(t=(t=t).append("svg:g").attr("id",t=>t.tid).attr("ord",t=>t.ord).classed("ver-node",!0)).append("svg:rect").classed("cmd-ver",!0).attr("x",0).attr("y",0).on("click",o).append("svg:title").text(t=>t.title),t.append("svg:text").attr("transform",t=>`translate(${15*t.lev}, ${VER_HEIGHT/2+5})`).text(t=>t.caption).on("click",R),t.filter(t=>1<t.lev).append("svg:path").classed("curve",!0),t.call(f)},t=>f(t),t=>_(t,e))}function E(t){t.classed("hide",!1).classed("sel",t=>t.sel).classed("exp",t=>null!=t.fst_child).classed("cls",t=>!!t.fst_child&&!t.exp).attr("transform",t=>`translate(${t.pad}, 0)`).select("path.curve").attr("d",t=>`M${HOR_WIDTH/2-10},${HOR_HEIGHT-15*t.lev+5}L${HOR_WIDTH/2-10},${HOR_HEIGHT-15*(t.lev-1)+5}
                ${t.parent.pad-t.pad+HOR_WIDTH/2-10},`+(HOR_HEIGHT-15*(t.lev-1)+5))}function g(e=!1){c.setHorRows(e);var t=c.getHorRows(0);d.selectAll("g.hor-node").data(t,t=>t.tid).join(t=>{(t=(t=t).append("svg:g").attr("id",t=>t.tid).attr("ord",t=>t.ord).classed("hor-node",!0)).append("svg:rect").classed("cmd-hor",!0).attr("x",0).attr("y",0).on("click",o).append("svg:title").text(t=>t.title),t.append("svg:text").attr("transform",t=>`translate(${HOR_WIDTH/2-12}, ${HOR_HEIGHT-15*t.lev}) rotate (-60)`).text(t=>t.caption).on("click",R),t.filter(t=>1<t.lev).append("svg:path").classed("curve",!0),t.call(E)},t=>E(t),t=>_(t,e))}function O(t,e=!1){console.time("refs");t=t.concat(t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t),t=t.concat(t);c.initFlow(t),console.timeEnd("refs"),e||(e=new MouseEvent("click"),i.select("#p2025").select("rect").node().dispatchEvent(e),i.select("#elz4").select("rect").node().dispatchEvent(e),i.select("#elz4").select("text").node().dispatchEvent(e),i.select("#dep01").select("rect").node().dispatchEvent(e)),setTimeout(D,0,!0),console.log("rows loaded:",t.length)}function m(t){t.classed("hide",!1).classed("sel",t=>t.sel).attr("transform",t=>`translate(${t.pad}, 0)`).select("text").text(t=>c.getFixVal(t.row,t.col,1))}function I(t,e,s){t.classed("hide",!1).classed("sel",t=>t.sel).attr("transform",t=>`translate(0, ${t.pad})`).selectAll("g.cell").data(e=>s.map(t=>({...t,row:e.row})),t=>t.tid).join(t=>{(t=(t=t).append("svg:g").classed("cell",!0).attr("key",t=>t.tid).attr("row",t=>t.row).attr("col",t=>t.col).attr("ord",t=>t.ord)).append("svg:rect").attr("x",0).attr("y",0),t.append("svg:text").attr("transform",`translate(${HOR_WIDTH-5}, ${VER_HEIGHT/2+5})`),t.call(m)},t=>m(t),t=>_(t,e))}function D(a=!1){var t=c.getVerRows(0);const o=c.getHorRows(0);l.selectAll("g.tape").data(t,t=>t.tid).join(t=>{var e,s;t=t,e=a,s=o,t.append("svg:g").classed("tape",!0).attr("key",t=>t.tid).attr("row",t=>t.row).attr("ord",t=>t.ord).call(I,e,s)},t=>I(t,a,o),t=>_(t,a))}d.attr("transform",`translate(${VER_WIDTH}, 0)`),i.attr("transform",`translate(0, ${HOR_HEIGHT})`),l.attr("transform",`translate(${VER_WIDTH}, ${HOR_HEIGHT})`),window.addEventListener("resize",s),n.on("touchstart",function(t){r.touchStartX=t.touches[0].clientX,r.touchStartY=t.touches[0].clientY}),n.on("touchmove",function(t){r.touchMoveX=t.touches[0].clientX,r.touchMoveY=t.touches[0].clientY,r.touchMove=!0}),n.on("touchend",function(t){var e=r.touchStartX-r.touchMoveX,s=r.touchStartY-r.touchMoveY;r.touchMove&&(t.preventDefault(),t=e,e=s,e=(e=r.posY+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<r.height-5*VER_HEIGHT-HOR_HEIGHT?e:r.height-5*VER_HEIGHT-HOR_HEIGHT,r.posY=e,t=(t=r.posX+PAD_ROOT*Math.round(t/PAD_ROOT))<0?0:t<r.width-5*HOR_WIDTH-VER_WIDTH?t:r.width-5*HOR_WIDTH-VER_WIDTH,r.posX=t,h.attr("y",e),i.attr("transform",`translate(0, ${HOR_HEIGHT-e})`),H.attr("x",t),d.attr("transform",`translate(${VER_WIDTH-t}, 0)`),p.attr("x",t),p.attr("y",e),l.attr("transform",`translate(${VER_WIDTH-t}, ${HOR_HEIGHT-e})`),r.touchMove=!1)}),n.on("wheel",function(t){var e;t.preventDefault(),t.shiftKey||0!=t.deltaX?(e=0!=t.deltaX?t.deltaX:t.deltaY,e=(e=r.posX+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<r.width-5*HOR_WIDTH-VER_WIDTH?e:r.width-5*HOR_WIDTH-VER_WIDTH,r.posX=e,H.attr("x",e),d.attr("transform",`translate(${VER_WIDTH-e}, 0)`),p.attr("x",e),l.attr("transform",`translate(${VER_WIDTH-e}, ${HOR_HEIGHT-r.posY})`)):(e=t.deltaY,e=(e=r.posY+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<r.height-5*VER_HEIGHT-HOR_HEIGHT?e:r.height-5*VER_HEIGHT-HOR_HEIGHT,r.posY=e,h.attr("y",e),i.attr("transform",`translate(0, ${HOR_HEIGHT-e})`),p.attr("y",e),l.attr("transform",`translate(${VER_WIDTH-r.posX}, ${HOR_HEIGHT-e})`))}),askJsonOrdsAsync("ords.json")(e)});