import{actionCreators,TYPES}from"./sutils.min.js";import dimsFactory from"./dims.min.js";const{askBinaryOrdsAsync,askBinaryDataAsync,askConfOrdsAsync,askConfDataAsync,askJsonOrdsAsync,askJsonDataAsync}=actionCreators,PAD_ROOT=25,VER_HEIGHT=25,VER_WIDTH=325,HOR_HEIGHT=200,HOR_WIDTH=120;window.addEventListener("load",function(){const l=dimsFactory(),a={height:1e3,width:1e3,posX:0,posY:0,overX:0,overY:0,touchMove:!1,touchStartX:0,touchStartY:0,touchMoveX:0,touchMoveY:0},n=(window.cobdy=l,d3.select("svg.multi")),d=n.select("g.hor-ords"),c=n.select("g.ver-ords"),i=n.select("g.matrix"),H=n.select("#hor-clip rect"),h=n.select("#ver-clip rect"),p=n.select("#mat-clip rect");function e(t){switch(t.type){case TYPES.ON_ERROR:console.error(t);break;case TYPES.INIT_ORDS:setTimeout(s,0,t.ords);break;case TYPES.INIT_DATA:setTimeout(E,0,t.rows);break;default:console.log("action.type",t.type)}}function r(){var t=document.body.clientWidth,t=t<=720?.5:t<=1080?.75:1,e=l.setHorRows(!1),r=l.setVerRows(!1),e=e+VER_WIDTH,r=r+HOR_HEIGHT,s=Math.round(e*t),o=Math.round(r*t);H.attr("width",Math.round(e/t)).attr("height",HOR_HEIGHT),h.attr("width",Math.round(VER_WIDTH)).attr("height",r),p.attr("width",Math.round(e/t)).attr("height",r),n.attr("viewBox",`0, 0, ${e}, `+r),n.attr("width",s).attr("height",o),a.height=r,a.width=e,l.createMatrix()}function s(t){l.loadOrds(t),l.setDimHor(1,!0),l.flipDims(0,1),l.setLays({PAD_ROOT:PAD_ROOT,VER_HEIGHT:VER_HEIGHT,VER_WIDTH:VER_WIDTH,HOR_HEIGHT:HOR_HEIGHT,HOR_WIDTH:HOR_WIDTH}),setTimeout(askBinaryDataAsync(),0,e),setTimeout(o,0),r()}function o(){l.setHorRows(!0),l.setVerRows(!0),O(!0),v(!0)}function u(t,e){1===e.act?setTimeout(T,0,e):3===e.act&&setTimeout(f,0,e,t.target.closest("g"))}function f(t,e){var r=l.getDim(t.ord);if(r.subn&&r.subn!=t)console.log("active neg differ");else{var s="sum"===r.mode,r=(r.mode=s?"sub":"sum",r.subn=s?t:null,r.hor?d.selectAll(`g.hor-node[ord="${t.ord}"]`):c.selectAll(`g.ver-node[ord="${t.ord}"]`)),o=l.selNodes(t.sa,s),a=l.selNodes(t.sb,s),t=(l.posNodes(t.sa,s),l.negNodes(t.sb,s),d3.select(e).classed("sub",s),r.data(o,t=>t.tid).classed("sel",t=>t.sel).classed("pos",t=>t.pos),r.data(a,t=>t.tid).classed("sel",t=>t.sel).classed("neg",t=>t.neg),l.getGrids());for(const n of t)l.zeroGrid(n),l.flowGrid(n),l.fillGrid(n);w(!0)}}function T(t){var e=l.getDim(t.ord),r=l.selNodes(t,!t.sel),t=((e.hor?d.selectAll(`g.hor-node[ord="${t.ord}"]`):c.selectAll(`g.ver-node[ord="${t.ord}"]`)).data(r,t=>t.tid).classed("sel",t=>t.sel),l.getFiltGrids(e.ord));for(const o of t){const s=performance.now();l.zeroGrid(o),l.flowGrid(o),l.fillGrid(o),performance.measure(`grid_${o.hOrd.ord}-`+o.vOrd.ord,{start:s,end:performance.now()})}const s=performance.now();w(!0),performance.measure("draw",{start:s,end:performance.now()});for(const a of performance.getEntries())"measure"==a.entryType&&console.log(`${a.name}. Duration ${a.duration}ms`);performance.clearMeasures()}function R(t,e){e.fst_child?(e.exp=!e.exp,(l.getDim(e.ord).hor?(l.setHorRows(!0),O):(l.setVerRows(!0),v))(!0),w(!0)):console.log("txt",e)}function _(t,e){e?t.classed("hide",!0):t.remove()}function g(t){t.classed("hide",!1).classed("sel",t=>t.sel).classed("exp",t=>null!=t.fst_child).classed("cls",t=>!!t.fst_child&&!t.exp).attr("transform",t=>`translate(0, ${t.pad})`).select("path.curve").attr("d",t=>`M${15*t.lev-5},12L${15*(t.lev-1)-5},12,${15*(t.lev-1)-5},`+(t.parent.pad-t.pad+12))}function v(e=!1){var t=l.getVerRows().filter(t=>0<t.lev);c.selectAll("g.ver-node").data(t,t=>t.tid).join(t=>{(t=(t=t).append("svg:g").attr("id",t=>t.tid).attr("ord",t=>t.ord).classed("ver-node",!0)).append("svg:rect").classed("cmd-ver",!0).attr("x",0).attr("y",0).on("click",u).append("svg:title").text(t=>t.title),t.append("svg:text").attr("transform",t=>`translate(${15*t.lev}, ${VER_HEIGHT/2+5})`).text(t=>t.caption).on("click",R),t.filter(t=>1<t.lev).append("svg:path").classed("curve",!0),t.call(g)},t=>g(t),t=>_(t,e))}function m(t){t.classed("hide",!1).classed("sel",t=>t.sel).classed("exp",t=>null!=t.fst_child).classed("cls",t=>!!t.fst_child&&!t.exp).attr("transform",t=>`translate(${t.pad}, 0)`).select("path.curve").attr("d",t=>`M${HOR_WIDTH/2-10},${HOR_HEIGHT-15*t.lev+5}L${HOR_WIDTH/2-10},${HOR_HEIGHT-15*(t.lev-1)+5}
                ${t.parent.pad-t.pad+HOR_WIDTH/2-10},`+(HOR_HEIGHT-15*(t.lev-1)+5))}function O(e=!1){var t=l.getHorRows().filter(t=>0<t.lev);d.selectAll("g.hor-node").data(t,t=>t.tid).join(t=>{(t=(t=t).append("svg:g").attr("id",t=>t.tid).attr("ord",t=>t.ord).classed("hor-node",!0)).append("svg:rect").classed("cmd-hor",!0).attr("x",0).attr("y",0).on("click",u).append("svg:title").text(t=>t.title),t.append("svg:text").attr("transform",t=>`translate(${HOR_WIDTH/2-12}, ${HOR_HEIGHT-15*t.lev}) rotate (-60)`).text(t=>t.caption).on("click",R),t.filter(t=>1<t.lev).append("svg:path").classed("curve",!0),t.call(m)},t=>m(t),t=>_(t,e))}function E(t){console.time("refs");var e=l.getDims(),t=t.concat(t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t),t=t.concat(t);for(const o of t){o.nodes=new Array(e.length);for(const a of e){var r=a.nodes.get(o.keys[a.ord]);r&&(o.nodes[a.ord]=r)}}l.setFlow(t),console.timeEnd("refs");var s=l.getDim(2).nodes.get("elz"),s=(l.selNodes(s,!0),l.getDim(3).nodes.get("dep")),s=(l.selNodes(s,!0),l.getGrids()[0]);l.flowGrid(s),l.fillGrid(s),setTimeout(w,0,!0),console.log("rows loaded:",t.length)}function I(t){t.classed("hide",!1).classed("sel",t=>t.sel).attr("transform",t=>`translate(${t.pad}, 0)`).select("text").text(t=>l.getFixVal(t.row,t.col,1))}function D(t,e,r){t.classed("hide",!1).classed("sel",t=>t.sel).attr("transform",t=>`translate(0, ${t.pad})`).selectAll("g.cell").data(e=>r.map(t=>({...t,row:e.row})),t=>t.tid).join(t=>{(t=(t=t).append("svg:g").classed("cell",!0).attr("key",t=>t.tid).attr("row",t=>t.row).attr("col",t=>t.col).attr("ord",t=>t.ord)).append("svg:rect").attr("x",0).attr("y",0),t.append("svg:text").attr("transform",`translate(${HOR_WIDTH-5}, ${VER_HEIGHT/2+5})`),t.call(I)},t=>I(t),t=>_(t,e))}function w(s=!1){var t=l.getMatrix(),e=t.getRows();const o=t.getCols();i.selectAll("g.tape").data(e,t=>t.tid).join(t=>{var e,r;t=t,e=s,r=o,t.append("svg:g").classed("tape",!0).attr("key",t=>t.tid).attr("row",t=>t.row).attr("ord",t=>t.ord).call(D,e,r)},t=>D(t,s,o),t=>_(t,s))}d.attr("transform",`translate(${VER_WIDTH}, 0)`),c.attr("transform",`translate(0, ${HOR_HEIGHT})`),i.attr("transform",`translate(${VER_WIDTH}, ${HOR_HEIGHT})`),window.addEventListener("resize",r),n.on("touchstart",function(t){a.touchStartX=t.touches[0].clientX,a.touchStartY=t.touches[0].clientY}),n.on("touchmove",function(t){a.touchMoveX=t.touches[0].clientX,a.touchMoveY=t.touches[0].clientY,a.touchMove=!0}),n.on("touchend",function(t){var e=a.touchStartX-a.touchMoveX,r=a.touchStartY-a.touchMoveY;a.touchMove&&(t.preventDefault(),t=e,e=r,e=(e=a.posY+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<a.height-5*VER_HEIGHT-HOR_HEIGHT?e:a.height-5*VER_HEIGHT-HOR_HEIGHT,a.posY=e,t=(t=a.posX+PAD_ROOT*Math.round(t/PAD_ROOT))<0?0:t<a.width-5*HOR_WIDTH-VER_WIDTH?t:a.width-5*HOR_WIDTH-VER_WIDTH,a.posX=t,h.attr("y",e),c.attr("transform",`translate(0, ${HOR_HEIGHT-e})`),H.attr("x",t),d.attr("transform",`translate(${VER_WIDTH-t}, 0)`),p.attr("x",t),p.attr("y",e),i.attr("transform",`translate(${VER_WIDTH-t}, ${HOR_HEIGHT-e})`),a.touchMove=!1)}),n.on("wheel",function(t){var e;t.preventDefault(),t.shiftKey||0!=t.deltaX?(e=0!=t.deltaX?t.deltaX:t.deltaY,e=(e=a.posX+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<a.width-5*HOR_WIDTH-VER_WIDTH?e:a.width-5*HOR_WIDTH-VER_WIDTH,a.posX=e,H.attr("x",e),d.attr("transform",`translate(${VER_WIDTH-e}, 0)`),p.attr("x",e),i.attr("transform",`translate(${VER_WIDTH-e}, ${HOR_HEIGHT-a.posY})`)):(e=t.deltaY,e=(e=a.posY+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<a.height-5*VER_HEIGHT-HOR_HEIGHT?e:a.height-5*VER_HEIGHT-HOR_HEIGHT,a.posY=e,h.attr("y",e),c.attr("transform",`translate(0, ${HOR_HEIGHT-e})`),p.attr("y",e),i.attr("transform",`translate(${VER_WIDTH-a.posX}, ${HOR_HEIGHT-e})`))}),askJsonOrdsAsync()(e)});