import{actionCreators,TYPES}from"./sutils.min.js";import dimsFactory from"./dims.min.js";const{askBinaryOrdsAsync,askBinaryDataAsync,askConfOrdsAsync,askConfDataAsync,askJsonOrdsAsync,askJsonDataAsync}=actionCreators,PAD_ROOT=25,VER_HEIGHT=25,VER_WIDTH=300,HOR_HEIGHT=200,HOR_WIDTH=100;window.addEventListener("load",function(){const n=dimsFactory(),r={height:1e3,width:1e3,posX:0,posY:0,touchMove:!1,touchStartX:0,touchStartY:0,touchMoveX:0,touchMoveY:0},l=d3.select("svg.multi"),d=l.select("g.hor-ords"),c=l.select("g.ver-ords"),i=l.select("g.matrix"),H=l.select("#hor-clip rect"),h=l.select("#ver-clip rect"),u=l.select("#mat-clip rect");function T(t){switch(t.type){case TYPES.ON_ERROR:console.error(t);break;case TYPES.INIT_ORDS:e=t.ords,n.loadOrds(e),n.setDimHor(1,!0),n.setLays({PAD_ROOT:PAD_ROOT,VER_HEIGHT:VER_HEIGHT,VER_WIDTH:VER_WIDTH,HOR_HEIGHT:HOR_HEIGHT,HOR_WIDTH:HOR_WIDTH}),setTimeout(askBinaryDataAsync(),0,T),setTimeout(O,100),setTimeout(v,200),p();break;case TYPES.INIT_DATA:var e=t.rows,s=(window.rows=JSON.stringify(e),console.time("refs"),n.getDims());for(const a of e){a.nodes=[];for(const r of s){var o=r.nodes.get(a.keys[r.ord]);o&&a.nodes.push(o)}}n.setFlow(e),console.timeEnd("refs"),setTimeout(E,0);break;default:console.log("action.type",t.type)}var e}function p(){var t=document.body.clientWidth,t=t<680?.5:t<1280?.75:1,e=n.setHorRows(),s=n.setVerRows(),e=e+VER_WIDTH,s=s+HOR_HEIGHT,o=Math.round(e*t),a=Math.round(s*t);H.attr("width",Math.round(e/t)).attr("height",s),h.attr("width",Math.round(e/t)).attr("height",s),u.attr("width",Math.round(e/t)).attr("height",s),l.attr("viewBox",`0, 0, ${e}, `+s),l.attr("width",o).attr("height",a),r.height=s,r.width=e}function s(t,e){1===e.act?setTimeout(a,0,e):3===e.act&&setTimeout(o,0,e,t.target.closest("g"))}function o(t,e){var s=n.getDim(t.ord);if(s.subn&&s.subn!=t)console.log("active neg differ");else{var o="sum"===s.mode,s=(s.mode=o?"sub":"sum",s.subn=o?t:null,s.hor?d.selectAll(`g.hor-node[ord="${t.ord}"]`):c.selectAll(`g.ver-node[ord="${t.ord}"]`)),a=n.selNodes(t.sa,o),r=n.selNodes(t.sb,o),t=(n.posNodes(t.sa,o),n.negNodes(t.sb,o),d3.select(e).classed("sub",o),s.data(a,t=>t.tid).classed("sel",t=>t.sel).classed("pos",t=>t.pos),s.data(r,t=>t.tid).classed("sel",t=>t.sel).classed("neg",t=>t.neg),n.getGrids());for(const l of t)n.zeroGrid(l),n.flowGrid(l),n.fillGrid(l);D(!0)}}function a(t){var e=n.getDim(t.ord),s=n.selNodes(t,!t.sel),t=((e.hor?d.selectAll(`g.hor-node[ord="${t.ord}"]`):c.selectAll(`g.ver-node[ord="${t.ord}"]`)).data(s,t=>t.tid).classed("sel",t=>t.sel),n.getFiltGrids(e.ord));for(const o of t)n.zeroGrid(o),n.flowGrid(o),n.fillGrid(o);D(!0)}function R(t,e){console.log(e,t),e.fst_child?(e.exp=!e.exp,(n.getDim(e.ord).hor?(n.setHorRows(!0),O):(n.setVerRows(!0),v))(!0),D(!0)):console.log("txt",e)}function _(t,e){e?t.classed("hide",!0):t.remove()}function f(t){t.classed("hide",!1).classed("sel",t=>t.sel).classed("exp",t=>null!=t.fst_child).classed("cls",t=>!!t.fst_child&&!t.exp).attr("transform",t=>`translate(0, ${t.pad})`).select("path.curve").attr("d",t=>`M${15*t.lev-5},12L${15*(t.lev-1)-5},12,${15*(t.lev-1)-5},`+(t.parent.pad-t.pad+12))}function v(e=!1){var t=n.getVerRows().filter(t=>0<t.lev);c.selectAll("g.ver-node").data(t,t=>t.tid).join(t=>{(t=(t=t).append("svg:g").attr("id",t=>t.tid).attr("ord",t=>t.ord).classed("ver-node",!0)).append("svg:rect").classed("cmd-ver",!0).attr("x",0).attr("y",0).on("click",s).append("svg:title").text(t=>t.title),t.append("svg:text").attr("transform",t=>`translate(${15*t.lev}, ${VER_HEIGHT/2+5})`).text(t=>t.caption).on("click",R),t.filter(t=>1<t.lev).append("svg:path").classed("curve",!0),t.call(f)},t=>f(t),t=>_(t,e))}function g(t){t.classed("hide",!1).classed("sel",t=>t.sel).classed("exp",t=>null!=t.fst_child).classed("cls",t=>!!t.fst_child&&!t.exp).attr("transform",t=>`translate(${t.pad}, 0)`).select("path.curve").attr("d",t=>`M${HOR_WIDTH/2-10},${HOR_HEIGHT-15*t.lev+5}L${HOR_WIDTH/2-10},${HOR_HEIGHT-15*(t.lev-1)+5}
                ${t.parent.pad-t.pad+HOR_WIDTH/2-10},`+(HOR_HEIGHT-15*(t.lev-1)+5))}function O(e=!1){var t=n.getHorRows().filter(t=>0<t.lev);d.selectAll("g.hor-node").data(t,t=>t.tid).join(t=>{(t=(t=t).append("svg:g").attr("id",t=>t.tid).attr("ord",t=>t.ord).classed("hor-node",!0)).append("svg:rect").classed("cmd-hor",!0).attr("x",0).attr("y",0).on("click",s).append("svg:title").text(t=>t.title),t.append("svg:text").attr("transform",t=>`translate(${HOR_WIDTH/2-12}, ${HOR_HEIGHT-15*t.lev}) rotate (-60)`).text(t=>t.caption).on("click",R),t.filter(t=>1<t.lev).append("svg:path").classed("curve",!0),t.call(g)},t=>g(t),t=>_(t,e))}function E(){var t=n.createMatrix();console.log(t.grids),setTimeout(D,0)}function I(t){t.classed("hide",!1).attr("transform",t=>`translate(${HOR_WIDTH+t.pad-5}, 0)`).select("text").text(t=>n.getFixVal(t.row,t.col))}function m(t,e,s){t.classed("hide",!1).attr("transform",t=>`translate(0, ${VER_HEIGHT/2+t.pad+5})`).selectAll("g.cell").data(e=>s.map(t=>({...t,row:e.row})),t=>t.tid).join(t=>{(t=(t=t).append("svg:g").classed("cell",!0).attr("key",t=>t.tid).attr("row",t=>t.row).attr("col",t=>t.col).attr("ord",t=>t.ord)).append("svg:text"),t.call(I)},t=>I(t),t=>_(t,e))}function D(o=!1){console.time("matrix");var t=n.getMatrix(),e=t.getRows();const a=t.getCols();i.selectAll("g.tape").data(e,t=>t.tid).join(t=>{var e,s;t=t,e=o,s=a,t.append("svg:g").classed("tape",!0).attr("key",t=>t.tid).attr("row",t=>t.row).attr("ord",t=>t.ord).call(m,e,s)},t=>m(t,o,a),t=>_(t,o)),console.timeEnd("matrix")}d.attr("transform",`translate(${VER_WIDTH}, 0)`),c.attr("transform",`translate(0, ${HOR_HEIGHT})`),i.attr("transform",`translate(${VER_WIDTH}, ${HOR_HEIGHT})`),window.addEventListener("resize",p),l.on("touchstart",function(t){r.touchStartX=t.touches[0].clientX,r.touchStartY=t.touches[0].clientY}),l.on("touchmove",function(t){t.preventDefault(),r.touchMoveX=t.touches[0].clientX,r.touchMoveY=t.touches[0].clientY,r.touchMove=!0}),l.on("touchend",function(t){var e,s;r.touchMove&&(e=r.touchStartX-r.touchMoveX,s=r.touchStartY-r.touchMoveY,e=e,s=s,s=(s=r.posY+PAD_ROOT*Math.round(s/PAD_ROOT))<0?0:s<r.height-5*VER_HEIGHT-HOR_HEIGHT?s:r.height-5*VER_HEIGHT-HOR_HEIGHT,r.posY=s,e=(e=r.posX+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<r.width-5*HOR_WIDTH-VER_WIDTH?e:r.width-5*HOR_WIDTH-VER_WIDTH,r.posX=e,h.attr("y",s),c.attr("transform",`translate(0, ${HOR_HEIGHT-s})`),H.attr("x",e),d.attr("transform",`translate(${VER_WIDTH-e}, 0)`),u.attr("x",e),u.attr("y",s),i.attr("transform",`translate(${VER_WIDTH-e}, ${HOR_HEIGHT-s})`),r.touchMove=!1,console.log(t))}),l.on("wheel",function(t){var e;t.preventDefault(),t.shiftKey||0!=t.deltaX?(e=0!=t.deltaX?t.deltaX:t.deltaY,e=(e=r.posX+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<r.width-5*HOR_WIDTH-VER_WIDTH?e:r.width-5*HOR_WIDTH-VER_WIDTH,r.posX=e,H.attr("x",e),d.attr("transform",`translate(${VER_WIDTH-e}, 0)`),u.attr("x",e),i.attr("transform",`translate(${VER_WIDTH-e}, ${HOR_HEIGHT-r.posY})`)):(e=t.deltaY,e=(e=r.posY+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<r.height-5*VER_HEIGHT-HOR_HEIGHT?e:r.height-5*VER_HEIGHT-HOR_HEIGHT,r.posY=e,h.attr("y",e),c.attr("transform",`translate(0, ${HOR_HEIGHT-e})`),u.attr("y",e),i.attr("transform",`translate(${VER_WIDTH-r.posX}, ${HOR_HEIGHT-e})`))}),askBinaryOrdsAsync()(T)});