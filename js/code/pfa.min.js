import{actionCreators,TYPES}from"./sutils.min.js";import dimsFactory from"./dims.min.js";const{askBinaryOrdsAsync,askBinaryDataAsync,askConfOrdsAsync,askConfDataAsync,askJsonOrdsAsync,askJsonDataAsync}=actionCreators,PAD_ROOT=25,VER_HEIGHT=25,VER_WIDTH=325,HOR_HEIGHT=200,HOR_WIDTH=100;window.addEventListener("load",function(){const n=dimsFactory(),r={height:1e3,width:1e3,posX:0,posY:0,overX:0,overY:0,touchMove:!1,touchStartX:0,touchStartY:0,touchMoveX:0,touchMoveY:0},l=(window.cobdy=n,d3.select("svg.multi"));l.select("g.corner");const d=l.select("g.hor-ords"),c=l.select("g.ver-ords"),i=l.select("g.matrix"),H=l.select("#hor-clip rect"),h=l.select("#ver-clip rect"),T=l.select("#mat-clip rect");function u(t){switch(t.type){case TYPES.ON_ERROR:console.error(t);break;case TYPES.INIT_ORDS:e=t.ords,n.loadOrds(e),n.setDimHor(1,!0),n.setLays({PAD_ROOT:PAD_ROOT,VER_HEIGHT:VER_HEIGHT,VER_WIDTH:VER_WIDTH,HOR_HEIGHT:HOR_HEIGHT,HOR_WIDTH:HOR_WIDTH}),setTimeout(askBinaryDataAsync(),0,u),setTimeout(E,100),setTimeout(v,200),p();break;case TYPES.INIT_DATA:var e=t.rows,s=(window.rows=JSON.stringify(e),console.time("refs"),n.getDims());for(const o of e){o.nodes=[];for(const r of s){var a=r.nodes.get(o.keys[r.ord]);a&&o.nodes.push(a)}}n.setFlow(e),console.timeEnd("refs"),setTimeout(O,0);break;default:console.log("action.type",t.type)}var e}function p(){var t=document.body.clientWidth,t=t<=720?.5:t<=1080?.75:1,e=n.setHorRows(),s=n.setVerRows(),e=e+VER_WIDTH,s=s+HOR_HEIGHT,a=Math.round(e*t),o=Math.round(s*t);H.attr("width",Math.round(e/t)).attr("height",HOR_HEIGHT),h.attr("width",Math.round(VER_WIDTH)).attr("height",s),T.attr("width",Math.round(e/t)).attr("height",s),l.attr("viewBox",`0, 0, ${e}, `+s),l.attr("width",a).attr("height",o),r.height=s,r.width=e}function s(t,e){1===e.act?setTimeout(o,0,e):3===e.act&&setTimeout(a,0,e,t.target.closest("g"))}function a(t,e){var s=n.getDim(t.ord);if(s.subn&&s.subn!=t)console.log("active neg differ");else{var a="sum"===s.mode,s=(s.mode=a?"sub":"sum",s.subn=a?t:null,s.hor?d.selectAll(`g.hor-node[ord="${t.ord}"]`):c.selectAll(`g.ver-node[ord="${t.ord}"]`)),o=n.selNodes(t.sa,a),r=n.selNodes(t.sb,a),t=(n.posNodes(t.sa,a),n.negNodes(t.sb,a),d3.select(e).classed("sub",a),s.data(o,t=>t.tid).classed("sel",t=>t.sel).classed("pos",t=>t.pos),s.data(r,t=>t.tid).classed("sel",t=>t.sel).classed("neg",t=>t.neg),n.getGrids());for(const l of t)n.zeroGrid(l),n.flowGrid(l),n.fillGrid(l);D(!0)}}function o(t){var e=n.getDim(t.ord),s=n.selNodes(t,!t.sel),t=((e.hor?d.selectAll(`g.hor-node[ord="${t.ord}"]`):c.selectAll(`g.ver-node[ord="${t.ord}"]`)).data(s,t=>t.tid).classed("sel",t=>t.sel),n.getFiltGrids(e.ord));for(const a of t)n.zeroGrid(a),n.flowGrid(a),n.fillGrid(a);D(!0)}function R(t,e){console.log(e,t),e.fst_child?(e.exp=!e.exp,(n.getDim(e.ord).hor?(n.setHorRows(!0),E):(n.setVerRows(!0),v))(!0),D(!0)):console.log("txt",e)}function _(t,e){e?t.classed("hide",!0):t.remove()}function f(t){t.classed("hide",!1).classed("sel",t=>t.sel).classed("exp",t=>null!=t.fst_child).classed("cls",t=>!!t.fst_child&&!t.exp).attr("transform",t=>`translate(0, ${t.pad})`).select("path.curve").attr("d",t=>`M${15*t.lev-5},12L${15*(t.lev-1)-5},12,${15*(t.lev-1)-5},`+(t.parent.pad-t.pad+12))}function v(e=!1){var t=n.getVerRows().filter(t=>0<t.lev);c.selectAll("g.ver-node").data(t,t=>t.tid).join(t=>{(t=(t=t).append("svg:g").attr("id",t=>t.tid).attr("ord",t=>t.ord).classed("ver-node",!0)).append("svg:rect").classed("cmd-ver",!0).attr("x",0).attr("y",0).on("click",s).append("svg:title").text(t=>t.title),t.append("svg:text").attr("transform",t=>`translate(${15*t.lev}, ${VER_HEIGHT/2+5})`).text(t=>t.caption).on("click",R),t.filter(t=>1<t.lev).append("svg:path").classed("curve",!0),t.call(f)},t=>f(t),t=>_(t,e))}function g(t){t.classed("hide",!1).classed("sel",t=>t.sel).classed("exp",t=>null!=t.fst_child).classed("cls",t=>!!t.fst_child&&!t.exp).attr("transform",t=>`translate(${t.pad}, 0)`).select("path.curve").attr("d",t=>`M${HOR_WIDTH/2-10},${HOR_HEIGHT-15*t.lev+5}L${HOR_WIDTH/2-10},${HOR_HEIGHT-15*(t.lev-1)+5}
                ${t.parent.pad-t.pad+HOR_WIDTH/2-10},`+(HOR_HEIGHT-15*(t.lev-1)+5))}function E(e=!1){var t=n.getHorRows().filter(t=>0<t.lev);d.selectAll("g.hor-node").data(t,t=>t.tid).join(t=>{(t=(t=t).append("svg:g").attr("id",t=>t.tid).attr("ord",t=>t.ord).classed("hor-node",!0)).append("svg:rect").classed("cmd-hor",!0).attr("x",0).attr("y",0).on("click",s).append("svg:title").text(t=>t.title),t.append("svg:text").attr("transform",t=>`translate(${HOR_WIDTH/2-12}, ${HOR_HEIGHT-15*t.lev}) rotate (-60)`).text(t=>t.caption).on("click",R),t.filter(t=>1<t.lev).append("svg:path").classed("curve",!0),t.call(g)},t=>g(t),t=>_(t,e))}function O(){var t=n.createMatrix();console.log(t.grids),setTimeout(D,0)}function I(t){t.classed("hide",!1).classed("sel",t=>t.sel).attr("transform",t=>`translate(${t.pad}, 0)`).select("text").text(t=>n.getFixVal(t.row,t.col))}function m(t,e,s){t.classed("hide",!1).classed("sel",t=>t.sel).attr("transform",t=>`translate(0, ${t.pad})`).selectAll("g.cell").data(e=>s.map(t=>({...t,row:e.row})),t=>t.tid).join(t=>{(t=(t=t).append("svg:g").classed("cell",!0).attr("key",t=>t.tid).attr("row",t=>t.row).attr("col",t=>t.col).attr("ord",t=>t.ord)).append("svg:rect").attr("x",0).attr("y",0),t.append("svg:text").attr("transform",`translate(${HOR_WIDTH-5}, ${VER_HEIGHT/2+5})`),t.call(I)},t=>I(t),t=>_(t,e))}function D(a=!1){console.time("matrix");var t=n.getMatrix(),e=t.getRows();const o=t.getCols();i.selectAll("g.tape").data(e,t=>t.tid).join(t=>{var e,s;t=t,e=a,s=o,t.append("svg:g").classed("tape",!0).attr("key",t=>t.tid).attr("row",t=>t.row).attr("ord",t=>t.ord).call(m,e,s)},t=>m(t,a,o),t=>_(t,a)),console.timeEnd("matrix")}d.attr("transform",`translate(${VER_WIDTH}, 0)`),c.attr("transform",`translate(0, ${HOR_HEIGHT})`),i.attr("transform",`translate(${VER_WIDTH}, ${HOR_HEIGHT})`),window.addEventListener("resize",p),l.on("touchstart",function(t){r.touchStartX=t.touches[0].clientX,r.touchStartY=t.touches[0].clientY}),l.on("touchmove",function(t){r.touchMoveX=t.touches[0].clientX,r.touchMoveY=t.touches[0].clientY,r.touchMove=!0}),l.on("touchend",function(t){var e=r.touchStartX-r.touchMoveX,s=r.touchStartY-r.touchMoveY;r.touchMove&&(t.preventDefault(),t=e,e=s,e=(e=r.posY+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<r.height-5*VER_HEIGHT-HOR_HEIGHT?e:r.height-5*VER_HEIGHT-HOR_HEIGHT,r.posY=e,t=(t=r.posX+PAD_ROOT*Math.round(t/PAD_ROOT))<0?0:t<r.width-5*HOR_WIDTH-VER_WIDTH?t:r.width-5*HOR_WIDTH-VER_WIDTH,r.posX=t,h.attr("y",e),c.attr("transform",`translate(0, ${HOR_HEIGHT-e})`),H.attr("x",t),d.attr("transform",`translate(${VER_WIDTH-t}, 0)`),T.attr("x",t),T.attr("y",e),i.attr("transform",`translate(${VER_WIDTH-t}, ${HOR_HEIGHT-e})`),r.touchMove=!1)}),l.on("wheel",function(t){var e;t.preventDefault(),t.shiftKey||0!=t.deltaX?(e=0!=t.deltaX?t.deltaX:t.deltaY,e=(e=r.posX+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<r.width-5*HOR_WIDTH-VER_WIDTH?e:r.width-5*HOR_WIDTH-VER_WIDTH,r.posX=e,H.attr("x",e),d.attr("transform",`translate(${VER_WIDTH-e}, 0)`),T.attr("x",e),i.attr("transform",`translate(${VER_WIDTH-e}, ${HOR_HEIGHT-r.posY})`)):(e=t.deltaY,e=(e=r.posY+PAD_ROOT*Math.round(e/PAD_ROOT))<0?0:e<r.height-5*VER_HEIGHT-HOR_HEIGHT?e:r.height-5*VER_HEIGHT-HOR_HEIGHT,r.posY=e,h.attr("y",e),c.attr("transform",`translate(0, ${HOR_HEIGHT-e})`),T.attr("y",e),i.attr("transform",`translate(${VER_WIDTH-r.posX}, ${HOR_HEIGHT-e})`))}),askBinaryOrdsAsync()(u)});